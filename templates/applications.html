<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุฅุฏุงุฑุฉ ุงูุชุทุจููุงุช | ููุญุฉ ุงูุชุญูู</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { background: #2c3e50; min-height: 100vh; color: white; padding: 20px; }
        .sidebar a { color: white; text-decoration: none; padding: 10px; border-radius: 5px; }
        .sidebar a:hover { background: #34495e; }
        .sidebar a.active { background: #3498db; }
        .calculator-info { background-color: #e7f3ff; border-right: 4px solid #0d6efd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .price-badge { background-color: #20c997; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .form-control:readonly { background-color: #f8f9fa; }
        .final-price-box { background-color: #d1e7dd; border: 1px solid #badbcc; border-radius: 5px; padding: 15px; margin-top: 15px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- ุงูุดุฑูุท ุงูุฌุงูุจู -->
        <div class="col-md-2 sidebar">
            <h4 class="text-center mb-4">ุฅุฏุงุฑุฉ ุงูุจูุช</h4>
            <hr>
            <ul class="nav flex-column">
                <li class="nav-item mb-2">
                    <a href="/" class="nav-link text-white">
                        <i class="fa fa-home me-2"></i> ุงูุฑุฆูุณูุฉ
                    </a>
                </li>
                <li class="nav-item mb-2">
                    <a href="/user_management" class="nav-link text-white">
                        <i class="fa fa-users me-2"></i> ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
                    </a>
                </li>
                <li class="nav-item mb-2">
                    <a href="/applications" class="nav-link text-white active">
                        <i class="fa fa-mobile me-2"></i> ุฅุฏุงุฑุฉ ุงูุชุทุจููุงุช
                    </a>
                </li>
                <li class="nav-item mb-2">
                    <a href="/categories" class="nav-link text-white">
                        <i class="fa fa-folder me-2"></i> ุฅุฏุงุฑุฉ ุงูุฃูุณุงู
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/logout" class="nav-link text-danger">
                        <i class="fa fa-sign-out-alt me-2"></i> ุฎุฑูุฌ
                    </a>
                </li>
            </ul>
            
            <hr class="my-4">
            
            <div class="mt-4">
                <h6>ุชุนุฏูู ุณุนุฑ ุงูุตุฑู</h6>
                <form action="/update_rate" method="POST" class="mt-3">
                    <div class="input-group">
                        <input type="number" step="any" name="new_rate" class="form-control" value="{{ rate }}" required>
                        <button type="submit" class="btn btn-sm btn-success">ุชุญุฏูุซ</button>
                    </div>
                </form>
            </div>
            
            <div class="mt-4">
                <a href="/categories" class="btn btn-primary w-100">
                    <i class="fa fa-folder me-2"></i>ุฅุฏุงุฑุฉ ุงูุฃูุณุงู
                </a>
            </div>
        </div>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <div class="col-md-10 p-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>๐ฑ ุฅุฏุงุฑุฉ ุงูุชุทุจููุงุช</h2>
                <div>
                    <a href="/categories" class="btn btn-primary me-2">
                        <i class="fa fa-folder me-2"></i>ุฅุฏุงุฑุฉ ุงูุฃูุณุงู
                    </a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAppModal">
                        <i class="fa fa-plus me-2"></i>ุฅุถุงูุฉ ุชุทุจูู ุฌุฏูุฏ
                    </button>
                </div>
            </div>

            <!-- ูุงุฆูุฉ ุงูุชุทุจููุงุช -->
            {% if applications %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5>ูุงุฆูุฉ ุงูุชุทุจููุงุช ({{ applications|length }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ุงููุณู</th>
                                    <th>ุงุณู ุงูุชุทุจูู</th>
                                    <th>ุณุนุฑ ุงููุญุฏุฉ</th>
                                    <th>ุงูุญุฏ ุงูุฃุฏูู</th>
                                    <th>ูุณุจุฉ ุงูุฑุจุญ</th>
                                    <th>ุงูุณุนุฑ ุงูููุงุฆู</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in applications %}
                                <tr>
                                    <td>{{ app[0] }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ app[7] }} {{ app[6] or 'ุจุฏูู ูุณู' }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ app[1] }}</strong>
                                    </td>
                                    <td>
                                        <span class="price-badge">${{ "%.6f"|format(app[2]) }}</span>
                                        <br>
                                        <small class="text-muted">{{ (app[2] * rate)|int }} ู.ุณ</small>
                                    </td>
                                    <td>{{ app[3] }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ app[4] }}%</span>
                                    </td>
                                    <td>
                                        {% set final_price = app[2] * (1 + app[4]/100) %}
                                        <span class="price-badge">${{ "%.6f"|format(final_price) }}</span>
                                        <br>
                                        <small class="text-muted">{{ (final_price * rate)|int }} ู.ุณ</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editAppModal{{ app[0] }}">
                                                <i class="fa fa-edit"></i> ุชุนุฏูู
                                            </button>
                                            <form action="/delete_application/{{ app[0] }}" 
                                                  method="POST" 
                                                  class="d-inline"
                                                  onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุชุทุจูู {{ app[1] }}ุ')">
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fa fa-trash"></i> ุญุฐู
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Modal ูุชุนุฏูู ุงูุชุทุจูู -->
                                <div class="modal fade" id="editAppModal{{ app[0] }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form action="/edit_application/{{ app[0] }}" method="POST">
                                                <div class="modal-header">
                                                    <h5>ุชุนุฏูู ุงูุชุทุจูู: {{ app[1] }}</h5>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">ุงุณู ุงูุชุทุจูู</label>
                                                        <input type="text" name="name" class="form-control" value="{{ app[1] }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">ุงููุณู</label>
                                                        <select name="category_id" class="form-control" required>
                                                            {% for cat in categories %}
                                                            <option value="{{ cat[0] }}" {% if cat[0] == app[5] %}selected{% endif %}>
                                                                {{ cat[3] }} {{ cat[2] }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">ุณุนุฑ ุงููุญุฏุฉ ($)</label>
                                                        <input type="number" step="0.000001" name="unit_price" class="form-control" value="{{ app[2] }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ</label>
                                                        <input type="number" name="min_units" class="form-control" value="{{ app[3] }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">ูุณุจุฉ ุงูุฑุจุญ %</label>
                                                        <input type="number" step="any" name="profit_percentage" class="form-control" value="{{ app[4] }}" min="0" max="100" required>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                                                    <button type="submit" class="btn btn-primary">ุญูุธ ุงูุชุนุฏููุงุช</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="fa fa-info-circle me-2"></i>
                ูุง ุชูุฌุฏ ุชุทุจููุงุช ุญุงููุงู. ูู ุจุฅุถุงูุฉ ุชุทุจูู ุฌุฏูุฏ.
            </div>
            {% endif %}
        </div>
    </div>
</div>
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5>โ๏ธ ุฎูุงุฑุงุช ุงูููุชุฌุงุช</h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                {% for app in applications %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ 'active' if loop.first else '' }}" 
                            id="tab-{{ app[0] }}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#options-{{ app[0] }}" 
                            type="button">
                        {{ app[1] }}
                    </button>
                </li>
                {% endfor %}
            </ul>
            
            <div class="tab-content mt-3">
                {% for app in applications %}
                <div class="tab-pane fade {{ 'show active' if loop.first else '' }}" 
                     id="options-{{ app[0] }}">
                     
                    <div class="d-flex justify-content-between mb-3">
                        <h6>ุฎูุงุฑุงุช {{ app[1] }}</h6>
                        <button class="btn btn-sm btn-success" 
                                onclick="showAddOptionModal({{ app[0] }}, '{{ app[1] }}')">
                            <i class="fa fa-plus"></i> ุฅุถุงูุฉ ุฎูุงุฑ
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ุงูุฎูุงุฑ</th>
                                    <th>ุงููููุฉ</th>
                                    <th>ุงูุณุนุฑ ($)</th>
                                    <th>ุงูุณุนุฑ (ู.ุณ)</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="options-{{ app[0] }}-tbody">
                                <!-- ูุชู ุงูุชุนุจุฆุฉ ุนุจุฑ AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

<!-- Modal ูุฅุถุงูุฉ ุชุทุจูู ุฌุฏูุฏ (ูุนุฏู - ูููุฉ ูุงุจูุฉ ููุชุนุฏูู) -->
<div class="modal fade" id="addAppModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="/add_application" method="POST">
                <div class="modal-header">
                    <h5>ุฅุถุงูุฉ ุชุทุจูู ุฌุฏูุฏ</h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- ุงูุนููุฏ ุงูุฃููู: ุงูุญุงุณุจุฉ ุงูุฐููุฉ -->
                        <div class="col-md-6">
                            <div class="calculator-info mb-3">
                                <h6><i class="fa fa-calculator me-2"></i>ุญุงุณุจุฉ ุงูุฃุณุนุงุฑ ุงูุฐููุฉ</h6>
                                <small class="text-muted">ุฃุฏุฎู ุงููููุฉ ูุงูุณุนุฑ ุงูุฐู ุชุฏูุนู ูุงุฎุชุฑ ุงูุนููุฉ.</small>
                            </div>

                            <!-- ุงููููุฉ (ูุงุจูุฉ ููุชุนุฏูู) -->
                            <div class="mb-3">
                                <label class="form-label">ุงููููุฉ (ุนุฏุฏ ุงููุญุฏุงุช) <span class="text-danger">*</span></label>
                                <input type="number" id="quantity" class="form-control" value="1000" min="1">
                                <small class="text-muted">ุฃุฏุฎู ุงููููุฉ ุงูุชู ุชุดุชุฑููุง ูู ุงููููุน (ูุซุงู: 1000ุ 500ุ 100)</small>
                            </div>

                            <!-- ุญูู ูุงุฎุชูุงุฑ ุนููุฉ ุงูุณุนุฑ ุงููุฏุฎู -->
                            <div class="mb-3">
                                <label class="form-label">ุนููุฉ ุงูุณุนุฑ ุงููุฏุฎู</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="inputCurrency" id="currencySYP" value="SYP" checked>
                                        <label class="form-check-label" for="currencySYP">๐ธ๐พ ููุฑุฉ ุณูุฑูุฉ (ู.ุณ)</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="inputCurrency" id="currencyUSD" value="USD">
                                        <label class="form-check-label" for="currencyUSD">๐บ๐ธ ุฏููุงุฑ ุฃูุฑููู ($)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- ุงูุณุนุฑ ุงููุฏุฎู -->
                            <div class="mb-3">
                                <label class="form-label" id="priceLabel">ุงูุณุนุฑ ุงููุฏููุน ููุงุจู ุงููููุฉ (ู.ุณ)</label>
                                <input type="number" id="inputPrice" class="form-control" step="any" placeholder="ูุซุงู: 130.29">
                                <small class="text-muted">ุฃุฏุฎู ุงูุณุนุฑ ุงูููู ุงูุฐู ุฏูุนุชู ูู ุงููููุน.</small>
                            </div>

                            <!-- ูุณุจุฉ ุงูุฑุจุญ -->
                            <div class="mb-3">
                                <label class="form-label">ูุณุจุฉ ุงูุฑุจุญ %</label>
                                <input type="number" id="profit_percentage" class="form-control" min="0" max="100" step="any" value="10">
                                <small class="text-muted">ุงููุณุจุฉ ุงููุฆููุฉ ุงูุชู ุชุฑูุฏ ุฑุจุญูุง.</small>
                            </div>
                        </div>
                        
                        <!-- ุงูุนููุฏ ุงูุฃูุณุฑ: ุงููุชุงุฆุฌ ูุจูุงูุงุช ุงูุชุทุจูู -->
                        <div class="col-md-6">
                            <!-- ุตูุฏูู ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ (ูุง ุณูุฑุงู ุงููุณุชุฎุฏู) -->
                            <div class="final-price-box mb-4">
                                <h6 class="text-success"><i class="fa fa-eye me-2"></i>ูุง ุณูุฑุงู ุงููุณุชุฎุฏู ูู ุงูุจูุช:</h6>
                                <hr>
                                <p>๐ฐ ุณุนุฑ ุงููุญุฏุฉ: 
                                    <strong><span id="final_unit_price_display">$0.000000</span></strong>
                                    <br>
                                    <small class="text-muted">(<span id="final_unit_price_syp_display">0</span> ู.ุณ)</small>
                                </p>
                                <p>๐ฆ ุงูุญุฏ ุงูุฃุฏูู ููุทูุจ: <strong><span id="min_units_display">100</span></strong></p>
                                <p>๐ต ุฃูู ุณุนุฑ ููุทูุจ: 
                                    <strong><span id="min_order_price_display">$0.00</span></strong>
                                    <br>
                                    <small class="text-muted">(<span id="min_order_price_syp_display">0</span> ู.ุณ)</small>
                                </p>
                            </div>

                            <!-- ุจูุงูุงุช ุงูุชุทุจูู ููุฅุฑุณุงู -->
                            <div class="mb-3">
                                <label class="form-label">ุงุณู ุงูุชุทุจูู <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" placeholder="ูุซุงู: ุดุฏุงุช ุจุจุฌู" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ุงููุณู <span class="text-danger">*</span></label>
                                <select name="category_id" class="form-control" required>
                                    <option value="">-- ุงุฎุชุฑ ุงููุณู --</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat[0] }}">{{ cat[3] }} {{ cat[2] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ุณุนุฑ ุงููุญุฏุฉ ุจุงูุฏููุงุฑ <span class="text-danger">*</span></label>
                                <input type="number" id="unit_price" name="unit_price" class="form-control" step="any" required readonly>
                                <small class="text-muted">ูุชู ุญุณุงุจู ุชููุงุฆูุงู (ุงููููุฉ ุงูุชู ุณุชุญูุธ)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ <span class="text-danger">*</span></label>
                                <input type="number" name="min_units" id="min_units_input" class="form-control" value="100" required>
                                <small class="text-muted">ุฃูู ูููุฉ ูููู ูููุณุชุฎุฏู ุทูุจูุง</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ูุณุจุฉ ุงูุฑุจุญ % <span class="text-danger">*</span></label>
                                <input type="number" name="profit_percentage" id="profit_percentage_final" class="form-control" min="0" max="100" step="any" value="10" required>
                                <small class="text-muted">ุงููุณุจุฉ ุงููุฆููุฉ ุงูุชู ุชุฑูุฏ ุฑุจุญูุง ูู ูู ุนูููุฉ</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="submit" class="btn btn-success">ุฅุถุงูุฉ ุงูุชุทุจูู</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ุญุงุณุจุฉ ุงูุฃุณุนุงุฑ ุงูุฐููุฉ ูุน ูููุฉ ูุงุจูุฉ ููุชุนุฏูู
    function calculatePrices() {
        // ุงูุญุตูู ุนูู ุงูููู ูู ุงููุฏุฎูุงุช
        const quantity = parseFloat(document.getElementById('quantity').value) || 0;
        const inputPrice = parseFloat(document.getElementById('inputPrice').value) || 0;
        const profitPercentage = parseFloat(document.getElementById('profit_percentage').value) || 0;
        const minUnits = parseFloat(document.getElementById('min_units_input').value) || 100;
        
        // ุชุญุฏูุฏ ุงูุนููุฉ ุงููุฎุชุงุฑุฉ
        const currencySYP = document.getElementById('currencySYP').checked;
        
        // ุงูุญููู ุงูุชู ุณูููู ุจุชุญุฏูุซูุง
        const unitPriceField = document.getElementById('unit_price');
        const finalUnitPriceSpan = document.getElementById('final_unit_price_display');
        const finalUnitPriceSypSpan = document.getElementById('final_unit_price_syp_display');
        const minOrderPriceSpan = document.getElementById('min_order_price_display');
        const minOrderPriceSypSpan = document.getElementById('min_order_price_syp_display');
        const minUnitsDisplay = document.getElementById('min_units_display');
        const profitPercentageFinal = document.getElementById('profit_percentage_final');
        
        // ุณุนุฑ ุงูุตุฑู ุงูุญุงูู ูู ุงูุซุงุจุช
        const rate = {{ rate }};
        
        // ุชุญุฏูุซ ูุต ุงูุชุณููุฉ ุญุณุจ ุงูุนููุฉ ุงููุฎุชุงุฑุฉ
        const priceLabel = document.getElementById('priceLabel');
        if (currencySYP) {
            priceLabel.textContent = 'ุงูุณุนุฑ ุงููุฏููุน ููุงุจู ุงููููุฉ (ู.ุณ)';
        } else {
            priceLabel.textContent = 'ุงูุณุนุฑ ุงููุฏููุน ููุงุจู ุงููููุฉ ($)';
        }
        
        // ุชุญุฏูุซ ุนุฑุถ ุงูุญุฏ ุงูุฃุฏูู
        if (minUnitsDisplay) {
            minUnitsDisplay.textContent = minUnits;
        }
        
        if (quantity > 0 && inputPrice > 0) {
            // 1. ุชุญููู ุงูุณุนุฑ ุงููุฏุฎู ุฅูู ุฏููุงุฑ ุฅุฐุง ูุงู ุจุงูููุฑุฉ ุงูุณูุฑูุฉ
            let priceInUsd;
            if (currencySYP) {
                // ุฅุฐุง ูุงู ุงููุฏุฎู ุจุงูููุฑุฉ ุงูุณูุฑูุฉุ ููุณูู ุนูู ุณุนุฑ ุงูุตุฑู
                priceInUsd = inputPrice / rate;
            } else {
                // ุฅุฐุง ูุงู ุงููุฏุฎู ุจุงูุฏููุงุฑุ ูุณุชุฎุฏูู ููุง ูู
                priceInUsd = inputPrice;
            }
            
            // 2. ุญุณุงุจ ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุตูู ุจุงูุฏููุงุฑ
            const originalUnitPriceInUsd = priceInUsd / quantity;
            
            // 3. ุฅุถุงูุฉ ูุณุจุฉ ุงูุฑุจุญ
            const profitMultiplier = 1 + (profitPercentage / 100);
            const finalUnitPriceInUsd = originalUnitPriceInUsd * profitMultiplier;
            
            // 4. ุญุณุงุจ ุฃุณุนุงุฑ ุงูุทูุจุงุช
            const minOrderPriceInUsd = finalUnitPriceInUsd * minUnits;
            
            // 5. ุชุญููู ูููุฑุฉ ุงูุณูุฑูุฉ ููุนุฑุถ
            const finalUnitPriceInSyp = finalUnitPriceInUsd * rate;
            const minOrderPriceInSyp = minOrderPriceInUsd * rate;
            
            // 6. ุชุญุฏูุซ ุงูุญููู
            // ุญูู ุณุนุฑ ุงููุญุฏุฉ ุงูุฐู ุณูุชู ุฅุฑุณุงูู ูุน ุงูููุฑู
            unitPriceField.value = finalUnitPriceInUsd.toFixed(6);
            
            // ุญููู ุงูุนุฑุถ
            finalUnitPriceSpan.textContent = '$' + finalUnitPriceInUsd.toFixed(6);
            finalUnitPriceSypSpan.textContent = Math.round(finalUnitPriceInSyp).toLocaleString();
            
            minOrderPriceSpan.textContent = '$' + minOrderPriceInUsd.toFixed(2);
            minOrderPriceSypSpan.textContent = Math.round(minOrderPriceInSyp).toLocaleString();
            
            // ุชุญุฏูุซ ุญูู ูุณุจุฉ ุงูุฑุจุญ ุงูููุงุฆู
            profitPercentageFinal.value = profitPercentage;
            
        } else {
            // ุฅุฐุง ูู ูุชู ุฅุฏุฎุงู ุจูุงูุงุช ูุงููุฉ
            unitPriceField.value = '';
            finalUnitPriceSpan.textContent = '$0.000000';
            finalUnitPriceSypSpan.textContent = '0';
            minOrderPriceSpan.textContent = '$0.00';
            minOrderPriceSypSpan.textContent = '0';
        }
    }
    
    // ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุญุงุณุจุฉ
    document.addEventListener('DOMContentLoaded', function() {
        // ุฌููุน ุงููุฏุฎูุงุช ุงูุชู ุชุคุซุฑ ุนูู ุงูุญุณุงุจ
        const quantityInput = document.getElementById('quantity');
        const inputPrice = document.getElementById('inputPrice');
        const profitPercentageInput = document.getElementById('profit_percentage');
        const currencySYP = document.getElementById('currencySYP');
        const currencyUSD = document.getElementById('currencyUSD');
        const minUnitsInput = document.getElementById('min_units_input');
        const profitFinalInput = document.getElementById('profit_percentage_final');
        
        // ูุงุฆูุฉ ุจูู ุงูุนูุงุตุฑ ุงูุชู ูุฌุจ ูุฑุงูุจุชูุง
        const elements = [
            quantityInput,
            inputPrice,
            profitPercentageInput,
            currencySYP,
            currencyUSD,
            minUnitsInput
        ];
        
        // ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ
        elements.forEach(element => {
            if (element) {
                element.addEventListener('input', calculatePrices);
                element.addEventListener('change', calculatePrices);
            }
        });
        
        // ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฃุฒุฑุงุฑ ุงูุฑุงุฏูู
        if (currencySYP && currencyUSD) {
            currencySYP.addEventListener('change', calculatePrices);
            currencyUSD.addEventListener('change', calculatePrices);
        }
        
        // ุชุญุฏูุซ ุงูุญุงุณุจุฉ ุนูุฏ ูุชุญ ุงูููุฏุงู
        const addAppModal = document.getElementById('addAppModal');
        if (addAppModal) {
            addAppModal.addEventListener('shown.bs.modal', function() {
                // ุฅุนุงุฏุฉ ุชุนููู ุงูููู ุงูุงูุชุฑุงุถูุฉ
                document.getElementById('currencySYP').checked = true;
                document.getElementById('quantity').value = 1000;
                document.getElementById('inputPrice').value = '';
                document.getElementById('profit_percentage').value = 10;
                document.getElementById('min_units_input').value = 100;
                calculatePrices();
            });
        }
        
        // ุชุญุฏูุซ ุงูุญุงุณุจุฉ ุนูุฏ ุชุบููุฑ ูุณุจุฉ ุงูุฑุจุญ ูู ุงูุญูู ุงูููุงุฆู
        if (profitFinalInput) {
            profitFinalInput.addEventListener('input', function() {
                document.getElementById('profit_percentage').value = this.value;
                calculatePrices();
            });
        }
        
        // ุชูููุฐ ุงูุญุณุงุจ ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุชุญููู
        calculatePrices();
    });

function loadOptions(appId) {
    fetch(`/api/options/${appId}`)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById(`options-${appId}-tbody`);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            data.forEach(opt => {
                const priceSyp = (opt.price_usd * {{ rate }}).toLocaleString();
                const row = `
                    <tr>
                        <td>${opt.name}</td>
                        <td>${opt.quantity}</td>
                        <td>$${opt.price_usd.toFixed(2)}</td>
                        <td>${priceSyp} ู.ุณ</td>
                        <td>
                            <span class="badge bg-${opt.is_active ? 'success' : 'secondary'}">
                                ${opt.is_active ? 'ูุดุท' : 'ูุนุทู'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editOption(${opt.id})">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-${opt.is_active ? 'danger' : 'success'}" 
                                    onclick="toggleOption(${opt.id})">
                                <i class="fa fa-${opt.is_active ? 'ban' : 'check'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        });
}

// ุชุญููู ุงูุฎูุงุฑุงุช ุนูุฏ ูุชุญ ุงูุชุจููุจ
document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (e) {
        const appId = this.id.replace('tab-', '');
        loadOptions(appId);
    });
});

// ุชุญููู ุฃูู ุชุจููุจ ุชููุงุฆูุงู
window.addEventListener('load', function() {
    const firstTab = document.querySelector('.nav-link.active');
    if (firstTab) {
        const appId = firstTab.id.replace('tab-', '');
        loadOptions(appId);
    }
});

// ุฏูุงู ูุณุงุนุฏุฉ ููุฎูุงุฑุงุช (ุชุญุชุงุฌ ุชูููุฐ)
function showAddOptionModal(appId, appName) {
    alert(`ุฅุถุงูุฉ ุฎูุงุฑ ูู ${appName} - ุณูุชู ุชูููุฐูุง ูุงุญูุงู`);
}

function editOption(optionId) {
    alert(`ุชุนุฏูู ุฎูุงุฑ ${optionId} - ุณูุชู ุชูููุฐูุง ูุงุญูุงู`);
}

function toggleOption(optionId) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุบููุฑ ุญุงูุฉ ูุฐุง ุงูุฎูุงุฑุ')) {
        fetch(`/api/option/toggle/${optionId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุชุจููุจ ุงููุดุท
                    const activeTab = document.querySelector('.nav-link.active');
                    if (activeTab) {
                        const appId = activeTab.id.replace('tab-', '');
                        loadOptions(appId);
                    }
                }
            });
    }
}
</script>
</body>
</html>
